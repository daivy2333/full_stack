# 漂流瓶功能问题检查清单

根据对项目代码的分析，以下是可能导致"捡起漂流瓶失败，请重试"错误的原因及检查清单：

## 1. API请求问题

### 1.1 后端API响应问题
- 检查后端API是否正确响应`/api/bottles/random`请求
- 检查服务器是否返回了有效的漂流瓶数据
- 查看服务器日志，确认是否有错误信息

### 1.2 前端请求问题
- 检查前端是否正确发送API请求
- 确认API基础URL是否正确设置（`http://localhost:3000/api`）
- 检查请求头是否正确设置（Content-Type和Authorization）

## 2. 数据库问题

### 2.1 数据库连接问题
- 确认数据库是否正常运行
- 检查数据库连接配置是否正确（db.js文件）
- 确认数据库连接池是否正常工作

### 2.2 数据库数据问题
- 检查bottles表中是否有可用的漂流瓶数据
- 确认bottles表中的is_active字段是否为TRUE
- 检查数据库中是否有足够的漂流瓶数据供随机选择

### 2.3 存储过程问题
- 检查get_random_unseen_bottle存储过程是否正确创建
- 确认存储过程是否能正确返回随机漂流瓶

## 3. 认证问题

### 3.1 JWT令牌问题
- 检查JWT_SECRET环境变量是否正确设置
- 确认JWT令牌是否正确生成和验证
- 检查authenticateToken中间件是否正常工作

### 3.2 用户状态问题
- 检查用户是否已正确登录
- 确认用户状态是否正确记录在user_states表中
- 检查用户是否有权限访问漂流瓶功能

## 4. 前端逻辑问题

### 4.1 状态管理问题
- 检查前端是否正确管理用户状态（hasPickedToday等）
- 确认开发者模式是否正确设置
- 检查currentBottle状态是否正确更新

### 4.2 错误处理问题
- 检查前端是否正确处理API错误响应
- 确认错误消息是否正确显示给用户
- 检查是否有未捕获的Promise错误

## 5. 跨域问题

### 5.1 CORS配置问题
- 检查后端是否正确配置CORS
- 确认前端请求是否被CORS策略阻止
- 检查浏览器控制台是否有CORS相关错误

## 6. 环境变量问题

### 6.1 后端环境变量
- 检查JWT_SECRET环境变量是否设置
- 确认数据库连接相关的环境变量是否正确设置
- 检查JWT_EXPIRE环境变量是否设置

## 7. 服务器问题

### 7.1 服务器状态
- 确认后端服务器是否正常运行（端口3000）
- 检查服务器日志是否有错误信息
- 确认服务器是否能处理并发请求

## 8. 数据库初始化问题

### 8.1 数据库表结构
- 检查所有表是否正确创建
- 确认外键约束是否正确设置
- 检查索引是否正确创建

## 9. 用户权限问题

### 9.1 匿名用户处理
- 检查匿名用户（ID=1）是否正确创建
- 确认匿名用户是否能正确创建漂流瓶
- 检查匿名用户是否能正确获取漂流瓶

## 10. 日志记录问题

### 10.1 错误日志
- 检查后端是否正确记录错误日志
- 确认前端是否正确记录控制台错误
- 检查是否有足够的调试信息

## 推荐调试步骤

1. 检查浏览器控制台错误
2. 检查后端服务器日志
3. 使用Postman或类似工具测试API端点
4. 检查数据库中的数据
5. 逐步注释代码以确定问题范围
6. 添加更多日志记录以跟踪问题

## 可能的解决方案

1. 确保后端服务器正常运行并监听3000端口
2. 检查并修复数据库连接问题
3. 确保数据库中有足够的漂流瓶数据
4. 修复前端API请求处理逻辑
5. 添加更详细的错误处理和用户反馈
