<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ”¶è— - æ¼‚æµç“¶</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        .saved-bottles-container {
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .saved-bottle {
            background-color: var(--secondary-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            min-height: 150px;
        }

        .saved-bottle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .saved-bottle-title {
            font-weight: 500;
            color: var(--primary-color);
        }

        .saved-bottle-date {
            font-size: 0.9rem;
            color: var(--light-text);
        }

        .saved-bottle-message {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 15px;
            font-style: italic;
        }

        .saved-bottle-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--light-text);
            flex-wrap: wrap;
            gap: 10px;
        }

        .saved-bottle-meta span {
            background-color: rgba(255, 255, 255, 0.7);
            padding: 5px 10px;
            border-radius: 15px;
        }

        .delete-btn {
            background-color: var(--error-color);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .delete-btn:hover {
            background-color: #d32f2f;
            transform: translateY(-2px);
        }

        .empty-message {
            text-align: center;
            padding: 40px 20px;
            color: var(--light-text);
            font-size: 1.2rem;
        }

        .back-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
            text-decoration: none;
            display: inline-block;
        }

        .back-btn:hover {
            background-color: #3a7bc8;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸŒŠ æˆ‘çš„æ”¶è— ğŸŒŠ</h1>
            <p>çè—é‚£äº›è§¦åŠ¨å¿ƒçµçš„æ¼‚æµç“¶</p>
        </header>

        <main>
            <div class="saved-bottles-container">
                <h2>æ”¶è—çš„æ¼‚æµç“¶</h2>
                <div id="saved-bottles-list">
                    <!-- ä¿å­˜çš„æ¼‚æµç“¶å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>

            <div class="footer-buttons">
                <a href="index.html" class="back-btn">â† è¿”å›ä¸»é¡µ</a>
            </div>
        </main>
    </div>

    <!-- æç¤ºæ¶ˆæ¯ -->
    <div id="toast" class="toast hidden"></div>

    <script>
        // DOM å…ƒç´ 
        const savedBottlesList = document.getElementById('saved-bottles-list');
        const toast = document.getElementById('toast');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadSavedBottles();
        });

        // åŠ è½½ä¿å­˜çš„æ¼‚æµç“¶
        async function loadSavedBottles() {
            try {
                // è·å–å½“å‰ç”¨æˆ·ID
                const userId = localStorage.getItem('bottleUser') ? 
                    JSON.parse(localStorage.getItem('bottleUser')).id : null;
                
                if (!userId) {
                    showToast('è¯·å…ˆç™»å½•', 'error');
                    return;
                }
                
                // ä»APIè·å–æ”¶è—çš„æ¼‚æµç“¶
                const token = localStorage.getItem('bottleToken');
                const response = await fetch(`http://localhost:3000/api/user/saves?userId=${userId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('è·å–æ”¶è—å¤±è´¥');
                }
                
                const savedBottles = await response.json();

                if (savedBottles.length === 0) {
                savedBottlesList.innerHTML = '<div class="empty-message">è¿˜æ²¡æœ‰æ”¶è—ä»»ä½•æ¼‚æµç“¶ï¼Œå¿«å»æ¡ä¸€äº›å–œæ¬¢çš„ç“¶å­å§ï¼</div>';
                return;
            }

            savedBottlesList.innerHTML = '';

            // æŒ‰ä¿å­˜æ—¥æœŸå€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
            savedBottles.sort((a, b) => new Date(b.savedDate) - new Date(a.savedDate));

            savedBottles.forEach((savedBottle, index) => {
                const bottleElement = createBottleElement(savedBottle, index);
                savedBottlesList.appendChild(bottleElement);
            });
            } catch (error) {
                console.error('åŠ è½½æ”¶è—å¤±è´¥:', error);
                savedBottlesList.innerHTML = `<div class="error-message">åŠ è½½æ”¶è—å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åˆ›å»ºæ¼‚æµç“¶å…ƒç´ 
        function createBottleElement(savedBottle, index) {
            const bottleDiv = document.createElement('div');
            bottleDiv.className = 'saved-bottle';

            bottleDiv.innerHTML = `
                <div class="saved-bottle-header">
                    <div class="saved-bottle-title">${savedBottle.annotation || 'æœªå‘½å'}</div>
                    <div class="saved-bottle-date">ä¿å­˜äº: ${formatDate(savedBottle.savedDate)}</div>
                </div>
                <div class="saved-bottle-message">${savedBottle.message}</div>
                <div class="saved-bottle-meta">
                    <span>ä½œè€…: ${savedBottle.author}</span>
                    <span>åŸæ—¥æœŸ: ${savedBottle.date}</span>
                    <span>ğŸš ${savedBottle.likes} ğŸ¦´ ${savedBottle.dislikes} ğŸ‘ ${savedBottle.views}</span>
                    <button class="delete-btn" data-index="${index}">åˆ é™¤</button>
                </div>
            `;

            // æ·»åŠ åˆ é™¤æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
            const deleteBtn = bottleDiv.querySelector('.delete-btn');
            deleteBtn.addEventListener('click', () => deleteSavedBottle(index));

            return bottleDiv;
        }

        // åˆ é™¤ä¿å­˜çš„æ¼‚æµç“¶
        async function deleteSavedBottle(index) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¼‚æµç“¶å—ï¼Ÿ')) {
                return;
            }

            try {
                // è·å–å½“å‰ç”¨æˆ·ID
                const userId = localStorage.getItem('bottleUser') ? 
                    JSON.parse(localStorage.getItem('bottleUser')).id : null;
                
                if (!userId) {
                    showToast('è¯·å…ˆç™»å½•', 'error');
                    return;
                }

                // è·å–æ‰€æœ‰æ”¶è—çš„æ¼‚æµç“¶ä»¥æ‰¾åˆ°è¦åˆ é™¤çš„é‚£ä¸ª
                const token = localStorage.getItem('bottleToken');
                const response = await fetch(`http://localhost:3000/api/user/saves?userId=${userId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('è·å–æ”¶è—å¤±è´¥');
                }
                
                const savedBottles = await response.json();
                const bottleToDelete = savedBottles[index];
                
                if (!bottleToDelete) {
                    throw new Error('æ‰¾ä¸åˆ°è¦åˆ é™¤çš„æ¼‚æµç“¶');
                }
                
                // ä»æœåŠ¡å™¨åˆ é™¤æ”¶è—
                const deleteResponse = await fetch(`http://localhost:3000/api/user/saves/${bottleToDelete.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('bottleToken')}`
                    }
                });
                
                if (!deleteResponse.ok) {
                    throw new Error('åˆ é™¤æ”¶è—å¤±è´¥');
                }

                showToast('æ¼‚æµç“¶å·²åˆ é™¤', 'success');
                loadSavedBottles(); // é‡æ–°åŠ è½½åˆ—è¡¨
            } catch (error) {
                console.error('åˆ é™¤æ”¶è—å¤±è´¥:', error);
                showToast(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'info') {
            toast.textContent = message;
            toast.className = 'toast';

            if (type === 'success') {
                toast.classList.add('success');
            } else if (type === 'error') {
                toast.classList.add('error');
            }

            toast.classList.remove('hidden');

            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }
    </script>
</body>
</html>