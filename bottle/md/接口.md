# 漂流瓶项目接口文档

## 1. 用户认证相关接口

### 1.1 用户注册
- **接口名称**: `register_user`
- **请求方法**: POST
- **请求参数**:
  - `username`: 用户名 (必填)
  - `email`: 邮箱 (可选)
  - `password_hash`: 密码哈希 (必填)
- **返回数据**:
  ```json
  {
    "userId": 1,
    "username": "用户名",
    "email": "邮箱",
    "message": "注册成功",
    "success": 1
  }
  ```
- **错误返回**:
  - 用户名已存在: `{"message": "用户名已存在", "success": 0}`
  - 邮箱已被注册: `{"message": "邮箱已被注册", "success": 0}`

### 1.2 用户登录
- **接口名称**: `login_user`
- **请求方法**: POST
- **请求参数**:
  - `username`: 用户名 (必填)
  - `password_hash`: 密码哈希 (必填)
- **返回数据**:
  ```json
  {
    "userId": 1,
    "username": "用户名",
    "email": "邮箱",
    "message": "登录成功",
    "success": 1
  }
  ```
- **错误返回**:
  - 用户名或密码错误: `{"message": "用户名或密码错误", "success": 0}`
  - 账户已被禁用: `{"message": "账户已被禁用，请联系管理员", "success": 0}`

### 1.3 获取用户信息
- **接口名称**: `get_user_info`
- **请求方法**: GET
- **请求参数**:
  - `userId`: 用户ID (必填)
- **返回数据**:
  ```json
  {
    "id": 1,
    "username": "用户名",
    "email": "邮箱",
    "created_at": "创建时间",
    "last_login": "最后登录时间",
    "is_active": true
  }
  ```

## 2. 用户状态管理接口

### 2.1 获取用户状态
- **接口名称**: `get_user_state`
- **请求方法**: GET
- **请求参数**:
  - `userId`: 用户ID (可选，匿名用户使用null)
- **返回数据**:
  ```json
  {
    "hasPickedToday": false,
    "hasThrownToday": false,
    "lastPickDate": "上次捡取日期",
    "lastThrowDate": "上次投放日期",
    "currentView": "pick",
    "devMode": false,
    "hasSeenTutorial": false
  }
  ```

### 2.2 更新用户状态
- **接口名称**: `update_user_state`
- **请求方法**: POST
- **请求参数**:
  - `userId`: 用户ID (可选，匿名用户使用null)
  - `hasPickedToday`: 是否已捡取漂流瓶 (可选)
  - `hasThrownToday`: 是否已投放漂流瓶 (可选)
  - `currentView`: 当前视图模式 (可选)
  - `devMode`: 开发者模式 (可选)
  - `hasSeenTutorial`: 是否已看过教程 (可选)
- **返回数据**: 更新后的用户状态 (同获取用户状态)

### 2.3 记录用户已捡起漂流瓶
- **接口名称**: `record_bottle_picked`
- **请求方法**: POST
- **请求参数**:
  - `userId`: 用户ID (可选，匿名用户使用null)
- **返回数据**: 无

## 3. 漂流瓶相关接口

### 3.1 获取随机漂流瓶
- **接口名称**: `get_random_bottle_with_stats`
- **请求方法**: GET
- **请求参数**:
  - `userId`: 用户ID (可选，匿名用户使用null)
- **返回数据**:
  ```json
  {
    "id": 1,
    "message": "漂流瓶内容",
    "author": "作者名",
    "date": "创建日期",
    "likes": 10,
    "dislikes": 2,
    "views": 100,
    "userReaction": "like" // null, "like" 或 "dislike"
  }
  ```
- **特殊情况**: 如果没有更多漂流瓶:
  ```json
  {
    "id": null,
    "message": "没有更多漂流瓶了",
    "author": null,
    "date": null,
    "likes": 0,
    "dislikes": 0,
    "views": 0,
    "userReaction": null
  }
  ```

### 3.2 对漂流瓶做出反应（点赞/点踩）
- **接口名称**: `react_to_bottle`
- **请求方法**: POST
- **请求参数**:
  - `userId`: 用户ID (必填)
  - `bottleId`: 漂流瓶ID (必填)
  - `reactionType`: 反应类型 ("like" 或 "dislike") (必填)
- **返回数据**:
  ```json
  {
    "likes": 10,
    "dislikes": 2,
    "userReaction": "like" // null, "like" 或 "dislike"
  }
  ```
- **错误返回**:
  - 漂流瓶不存在或已被删除: `{"message": "漂流瓶不存在或已被删除"}`

### 3.3 获取漂流瓶详细信息
- **接口名称**: `get_bottle_details`
- **请求方法**: GET
- **请求参数**:
  - `userId`: 用户ID (可选，匿名用户使用null)
  - `bottleId`: 漂流瓶ID (必填)
- **返回数据**:
  ```json
  {
    "id": 1,
    "message": "漂流瓶内容",
    "author": "作者名",
    "date": "创建日期",
    "likes": 10,
    "dislikes": 2,
    "views": 100,
    "userReaction": "like", // null, "like" 或 "dislike"
    "userAnnotation": "备注" // null 或用户备注
  }
  ```
- **错误返回**:
  - 漂流瓶不存在或已被删除: `{"message": "漂流瓶不存在或已被删除"}`

### 3.4 创建漂流瓶
- **接口名称**: `create_bottle`
- **请求方法**: POST
- **请求参数**:
  - `userId`: 用户ID (可选，匿名用户使用null)
  - `message`: 漂流瓶内容 (必填)
  - `authorName`: 作者名 (可选)
- **返回数据**:
  ```json
  {
    "id": 1,
    "message": "漂流瓶内容",
    "author": "作者名",
    "date": "创建日期",
    "likes": 0,
    "dislikes": 0,
    "views": 0,
    "userReaction": null
  }
  ```
- **错误返回**:
  - 今天已经投放过漂流瓶了，请明天再来: `{"message": "今天已经投放过漂流瓶了，请明天再来"}`

## 4. 用户收藏相关接口

### 4.1 获取用户收藏的漂流瓶
- **接口名称**: `get_user_saved_bottles`
- **请求方法**: GET
- **请求参数**:
  - `userId`: 用户ID (可选，匿名用户使用null)
- **返回数据**:
  ```json
  [
    {
      "id": 1,
      "message": "漂流瓶内容",
      "author": "作者名",
      "date": "创建日期",
      "views": 100,
      "savedDate": "收藏日期",
      "annotation": "备注",
      "likes": 10,
      "dislikes": 2
    },
    // 更多漂流瓶...
  ]
  ```

### 4.2 收藏漂流瓶
- **接口名称**: `save_bottle`
- **请求方法**: POST
- **请求参数**:
  - `userId`: 用户ID (可选，匿名用户使用null)
  - `bottleId`: 漂流瓶ID (必填)
  - `annotation`: 备注 (可选)
- **返回数据**:
  ```json
  {
    "message": "收藏成功",
    "success": 1
  }
  ```
- **错误返回**:
  - 漂流瓶不存在或已被删除: `{"message": "漂流瓶不存在或已被删除"}`
  - 已经收藏过这个漂流瓶: `{"message": "已经收藏过这个漂流瓶"}`

### 4.3 取消收藏漂流瓶
- **接口名称**: `unsave_bottle`
- **请求方法**: POST
- **请求参数**:
  - `userId`: 用户ID (可选，匿名用户使用null)
  - `bottleId`: 漂流瓶ID (必填)
- **返回数据**:
  ```json
  {
    "message": "取消收藏成功",
    "success": 1
  }
  ```
- **错误返回**:
  - 未找到收藏记录: `{"message": "未找到收藏记录"}`

## 5. 管理相关接口

### 5.1 获取系统统计信息
- **接口名称**: `get_system_stats`
- **请求方法**: GET
- **请求参数**: 无
- **返回数据**:
  ```json
  // 用户统计
  {
    "total_users": 100,
    "active_users": 95,
    "new_users_today": 5
  },
  // 漂流瓶统计
  {
    "total_bottles": 500,
    "active_bottles": 480,
    "new_bottles_today": 10,
    "new_bottles_yesterday": 8
  },
  // 互动统计
  {
    "total_likes": 1000,
    "total_dislikes": 200,
    "total_saves": 300,
    "total_views": 5000
  },
  // 活跃度统计
  {
    "active_users_today": 30,
    "active_users_yesterday": 25
  }
  ```

### 5.2 删除漂流瓶（软删除）
- **接口名称**: `delete_bottle`
- **请求方法**: POST
- **请求参数**:
  - `bottleId`: 漂流瓶ID (必填)
- **返回数据**:
  ```json
  {
    "affected_rows": 1,
    "message": "漂流瓶已删除"
  }
  ```

### 5.3 禁用用户
- **接口名称**: `disable_user`
- **请求方法**: POST
- **请求参数**:
  - `userId`: 用户ID (必填)
- **返回数据**:
  ```json
  {
    "affected_rows": 1,
    "message": "用户已禁用"
  }
  ```

### 5.4 启用用户
- **接口名称**: `enable_user`
- **请求方法**: POST
- **请求参数**:
  - `userId`: 用户ID (必填)
- **返回数据**:
  ```json
  {
    "affected_rows": 1,
    "message": "用户已启用"
  }
  ```

## 6. 前端开发注意事项

1. **匿名用户处理**:
   - 匿名用户ID固定为1
   - 匿名用户可以查看漂流瓶但不能创建漂流瓶或进行收藏

2. **用户状态管理**:
   - 用户每天只能捡取一个漂流瓶
   - 用户每天只能投放一个漂流瓶
   - 需要在前端检查用户状态并相应地启用/禁用相关功能

3. **漂流瓶互动**:
   - 用户可以对漂流瓶点赞或点踩，但只能选择一种
   - 用户可以收藏漂流瓶并添加备注

4. **错误处理**:
   - 所有接口都应进行适当的错误处理
   - 向用户显示友好的错误信息

5. **数据格式**:
   - 日期格式应统一为YYYY-MM-DD
   - 时间戳格式应统一为ISO 8601标准
